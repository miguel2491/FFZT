@using Facturafast.Models
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1 class="h3 mb-3">PrePagos</h1>
<div class="row">
    <div class="col-md-2 col-xs-2">
        <input type="hidden" value="@ViewBag.ID" id="idprepago" />
        <button class="btn btn-danger btnEstatus mb-3" id="btnTimbrar" style="visibility:hidden" onclick="timbrarModal()">Timbrar</button><br />
        <a class="btn btn-warning btnPrePago mb-3" href="/Facturacion/Complemento?id=@ViewBag.ID" style="visibility: hidden"><i class="fas fa-edit"></i> Editar</a><br />
        <a class="btn btn-success btnPrePago" id="btnListar" href='/Facturacion/ListaComplemento' style="visibility: hidden"><i class="fas fa-file-alt"></i> Listar</a>
    </div>
    <div class="col-md-10 col-xs-10" id="d_prepagos" style="visibility:hidden">
        <div class="card">
            <div class="card-header">

            </div>
            <div class="row rpdf">

            </div>
        </div>
    </div>
</div>
<!-- MODAL FACTS -->
<div class="modal fade" id="modalTimbrado" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Timbrar</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body m-3">
                <input type="hidden" id="idprefac_modal" />
                <input type="hidden" id="correo_cliente" />
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-floating mb-12">
                            <input type="text" class="form-control form-control-lg text-uppercase" readonly id="uso_cfdi">
                            <label for="uso_cfdi">Uso CFDI</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-floating mb-4">
                            <input type="text" class="form-control form-control-lg text-uppercase" readonly id="metodo_pago">
                            <label for="metodo_pago">Método Pago</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating mb-4">
                            <input type="text" class="form-control form-control-lg text-uppercase" readonly id="total">
                            <label for="total">Total</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-floating mb-4">
                            <input type="text" class="form-control form-control-lg text-uppercase" readonly id="rfc_receptor">
                            <label for="rfc_emisor">RFC</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-floating mb-4">
                            <input type="text" class="form-control form-control-lg text-uppercase" readonly id="razon_recpetor">
                            <label for="razon_emisor">Razón Social</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="timbrar()" id="btnTimbre"><i class="fas fa-bell"></i>&nbsp; Timbrar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCerrar"><i class="fas fa-remove"></i>&nbsp; Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    setTimeout(function () { abrirCargando(); previsualizar(); }, 1000);
    const id = '@ViewBag.ID';

    function previsualizar()
    {
        $("#d_prepagos").css("visibility", "visible");
        //-------------------------------------------------------------------------
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: '/Facturacion/VisPrePagos?id=' + id,
            data: JSON.stringify({ 'id': id }),
            success: function (data) {
                var response = data;
                if (response == "NG") {
                    previsualizar();
                }
                else {
                    f_pdf = response;
                    //setTimeout(function () {
                        if ('@ViewBag.Estatus' == "1") {
                            $(".btnEstatus").css("visibility", "visible");
                            genXML(id);
                        }
                        $(".rpdf").html('<iframe src="/' + response + '" style="height:100vh"></iframe>');
                        cerrarCargando();
                        $(".btnPrePago").css("visibility", "visible");
                        f_doc = f_pdf.replace('PDF', 'DOCX');
                        f_doc = f_doc.replace('.pdf', '.docx');
                        
                    //}, 15000);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                notificacionAlert("Ocurrio un error, vuelva a intentar", "danger");
                cerrarCargando();
            }
        });
        //-------------------------------------------------------------------------
    }

    function timbrarModal()
    {

        $("#idprefac_modal").val('@ViewBag.ID');
        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalTimbrado")).show();
        $.get("@Url.Action("getPrePagoID", "Facturacion")?id=" + id, async function (data) {
            $("#correo_cliente").val(data.correo);
            $("#metodo_pago").val(data.s_metodo_pago);
            $("#uso_cfdi").val(data.s_uso_cfdi);
            $("#total").val(data.total);
            $("#razon_recpetor").val(data.nombre_razon);
            $("#rfc_receptor").val(data.rfc);
        });
    }

    function timbrar()
    {
        $("#btnTimbre").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span class= "sr-only">Loading...</span>');
        $("#btnCerrar").css("disabled",true);

        let id = $("#idprefac_modal").val();
        abrirCargando();
        $("#btnPreTimbrar").css("display", "block");
        $("#btnTimbrar").css("display", "none");
        //-------------------------------------------------------------------------
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: '/XML/TimbrarXML?id_=' + id,
            data: JSON.stringify({ 'id_': id,'n_doc':'Fac_Pago.xml', 'tipo':'Pago' }),
            success: function (data) {
                var response = data;
                response = response.split("|");
                console.log(response);
                if (response[0] == "Timbrado" || response[0] =="Timdrado") {
                    notificacionAlert("Timbrada Correctamente", "success");
                    setTimeout(function () {
                        $(".modal-footer").html('<button class="btn btn-primary" onclick=sendcorreo()><i class="fas fa-envelope"></i>&nbsp; Enviar Correo</button>' +
                            '<a target="_blank" class="btn btn-success" href="../' + f_pdf + '"><i class="fas fa-file"></i>&nbsp; Descargar PDF</button>' +
                            '<a class="btn btn-info" href="../' + f_doc + '"><i class="fas fa-file"></i>&nbsp; Descargar XML</button>');
                    }, 5000);
                    cerrarCargando();
                } else {
                    notificacionAlert("Ocurrio un error, " + response[2] + ",vuelva a intentar", "danger");
                    cerrarCargando();
                }

            },
            error: function (jqXHR, textStatus, errorThrown) {
                notificacionAlert("Ocurrio un error, vuelva a intentar", "danger");
                cerrarCargando();
            }
        });
        //-------------------------------------------------------------------------
    }

    function sendcorreo()
    {
        abrirCargando();
        let correo = $("#correo_cliente").val();
        let id = $("#idprefac_modal").val();
        //-------------------------------------------------------------------------
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: '/Facturacion/EnviarCorreo',
            data: JSON.stringify({ 'id_': id, 'correo_': correo, 'tipo': 'Prepago'}),
            success: function (data) {
                var response = data;
                console.log(response);
                cerrarCargando();
                if (response == "Enviado") {
                    notificacionAlert("Correo enviado satisfactoriamente.", "success");
                    setTimeout(function () { window.location = '@Url.Action("ListaComplemento", "Facturacion")' }, 3000);
                } else {
                    notificacionAlert("Ocurrio un problema al enviar el correo, intentelo mas tarde.", "danger");
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                notificacionAlert("Ocurrio un error, vuelva a intentar", "danger");
                cerrarCargando();
            }
        });
        //-------------------------------------------------------------------------
    }

    function genXML(id)
    {
        //-------------------------------------------------------------------------
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: '/XML/genPagoXML?id=' + id,
            data: JSON.stringify({ 'id': id }),
            success: function (data) {
                var response = data;
                console.log(response);
                
            },
            error: function (jqXHR, textStatus, errorThrown) {
                //notificacionAlert("Ocurrio un error, vuelva a intentar", "danger");
                cerrarCargando();
            }
        });
        //-------------------------------------------------------------------------
    }
</script>